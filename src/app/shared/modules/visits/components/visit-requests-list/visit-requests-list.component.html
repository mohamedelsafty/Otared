<section>
  <div class="l-f-between">
    <div class="page-header">
      <h2 class="page-header__title">
        طلبات الزيارة
      </h2>
      <p class="page-header__caption">
        يمكنك رؤية طلبات الزيارة التي قام العملاء بها علي الوحدات الخاصة بك
      </p>
    </div>
  </div>
  <div class="row">
    <div class="col-md-3">
      <div class="form-group">
        <input
          class="form-control search-input"
          (keyup)="keyDownFunction($event)"
          placeholder="ابحث في الطلبات"
        />
      </div>
    </div>
    <div class="col-md-6"></div>
    <div class="col-md-3" *ngIf="visitsService.filterVisibility">
      <div class="main-button-group l-f-end">
        <button
          class="button button--white m-0"
          (click)="visitsService.setFilter(null)"
          [ngClass]="{ 'button--blue': !visitsService.targetFilter }"
        >
          الكل
        </button>
        <button
          class="button button--white m-0"
          (click)="visitsService.setFilter('accepted')"
          [ngClass]="{
            'button--blue': visitsService.targetFilter === 'accepted'
          }"
        >
          موافق عليه
        </button>
        <button
          class="button button--white m-0"
          (click)="visitsService.setFilter('canceled')"
          [ngClass]="{
            'button--blue': visitsService.targetFilter === 'canceled'
          }"
        >
          الملغاة
        </button>
      </div>
    </div>
  </div>

  <div
    class="main-table"
    *ngIf="!visitsService.isLoading && visitsService.filter().length"
  >
    <table mat-table [dataSource]="visitsService.filter()">
      <!-- Position Column -->
      <ng-container matColumnDef="id">
        <th mat-header-cell *matHeaderCellDef>رقم</th>
        <td mat-cell *matCellDef="let element">{{ element.id }}</td>
      </ng-container>

      <!-- Name Column -->
      <ng-container matColumnDef="projectName">
        <th mat-header-cell *matHeaderCellDef>اسم المشروع</th>
        <td mat-cell *matCellDef="let element">
          {{ element.project ? element.project.name : element.project_name }}
        </td>
      </ng-container>

      <!-- Weight Column -->
      <ng-container matColumnDef="instancesName">
        <th mat-header-cell *matHeaderCellDef>اسم النموذج</th>
        <td mat-cell *matCellDef="let element">
          {{ element.instance ? element.instance.name : element.instance_name }}
        </td>
      </ng-container>

      <!-- Symbol Column -->
      <ng-container matColumnDef="unitStatus">
        <th mat-header-cell *matHeaderCellDef>حالة الوحدة</th>
        <td mat-cell *matCellDef="let element">
          <span *ngIf="element.instance?.instance_type == 'SaleOnmap'">
            بيع على الخارطة
          </span>
          <span *ngIf="element.instance?.instance_type == 'ReadyUnits'">
            وحدات جاهزة
          </span>
          <span *ngIf="element.instance_type_name">
            {{ element.instance_type_name }}
          </span>
        </td>
      </ng-container>

      <!-- unit Column -->
      <ng-container matColumnDef="clientName">
        <th mat-header-cell *matHeaderCellDef>
          {{ auth.getUser().type === "Client" ? "اسم المطور" : "اسم العميل" }}
        </th>
        <td mat-cell *matCellDef="let element">
          {{ element.client ? element.client.name : element.dev_name }}
        </td>
      </ng-container>

      <!-- client Column -->
      <ng-container matColumnDef="clientPhone">
        <th mat-header-cell *matHeaderCellDef>
          <span *ngIf="auth.getUser().type !== 'Client'">بيانات التواصل</span>
        </th>
        <td mat-cell *matCellDef="let element">
          {{ element.client?.client_phone_number }}
        </td>
      </ng-container>

      <!-- reservation Column -->
      <ng-container matColumnDef="status">
        <th mat-header-cell *matHeaderCellDef>حاله الطلب</th>
        <td mat-cell *matCellDef="let element">
          <span *ngIf="element.visit_status === 'new'">
            منتظر الموافقة
          </span>
          <span
            *ngIf="
              element.visit_status === 'accepted' ||
              element.visit_status === 'Accepted'
            "
          >
            تم التواصل والموافقة
          </span>
          <span
            *ngIf="
              element.visit_status === 'canceled' ||
              element.visit_status === 'Canceled'
            "
          >
            تم الرفض
          </span>
          <span *ngIf="element.visit_status === 'expired'">
            منتهي
          </span>
          <span *ngIf="element.status_text">
            {{ element.status_text }}
          </span>
        </td>
      </ng-container>

      <!-- action Column -->
      <ng-container matColumnDef="action">
        <th mat-header-cell *matHeaderCellDef></th>
        <td mat-cell *matCellDef="let element">
          <div>
            <button
              matTooltip="موافقة"
              [disabled]="visitsService.isSaving"
              mat-icon-button
              *ngIf="element.visit_status === 'new'"
              (click)="visitsService.changeStatus(element.id, 'accepted')"
            >
              <svg class="main-table__icon main-table__icon--primary">
                <use xlink:href="/assets/image/svg-icons.svg#icon-check"></use>
              </svg>
            </button>
            <button
              matTooltip="رفض"
              [disabled]="visitsService.isSaving"
              mat-icon-button
              (click)="visitsService.changeStatus(element.id, 'canceled')"
              *ngIf="
                element.visit_status === 'new' ||
                element.visit_status === 'accepted' ||
                element.visit_status === 'Accepted'
              "
            >
              <svg class="main-table__icon main-table__icon--red">
                <use xlink:href="/assets/image/svg-icons.svg#icon-close"></use>
              </svg>
            </button>
            <button
              matTooltip="حذف"
              [disabled]="visitsService.isSaving"
              mat-icon-button
              (click)="visitsService.destroy(element.id)"
              *ngIf="element.status"
            >
              <svg class="main-table__icon main-table__icon--red">
                <use xlink:href="/assets/image/svg-icons.svg#icon-close"></use>
              </svg>
            </button>
            <button
              matTooltip="معاينه"
              [disabled]="visitsService.isSaving"
              mat-icon-button
              (click)="show(element.id)"
            >
              <svg class="main-table__icon main-table__icon--blue">
                <use
                  xlink:href="/assets/image/svg-icons.svg#icon-visibility"
                ></use>
              </svg>
            </button>
          </div>
        </td>
      </ng-container>

      <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
      <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>
    </table>

    <div *ngIf="!visitsService.isLoading">
      <pagination
        [page]="visitsService.page"
        [total]="visitsService.total"
        [perPage]="visitsService.perPage"
        (change)="visitsService.findAll($event)"
      ></pagination>
    </div>
  </div>
  <div class="loading" *ngIf="visitsService.isLoading">
    <mat-spinner diameter="75" strokeWidth="3"></mat-spinner>
  </div>
  <empty-state
    *ngIf="!visitsService.filter().length && !visitsService.isLoading"
  ></empty-state>
</section>
